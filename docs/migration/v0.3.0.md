# Zenith v0.3.0 Migration Guide

## Overview
Zenith v0.3.0 introduces Rails-like developer experience improvements with breaking changes to create a cleaner, more intuitive API.

## Breaking Changes

### 1. Removed Redundant Aliases
The following exports have been removed from `zenith` package. Use the recommended alternatives:

| Removed | Use Instead | Example |
|---------|------------|---------|
| `ServiceDecorator` | `Service` base class | `class MyService(Service):` |
| `AuthDependency` | `Auth` | `user=Auth` |
| `FileDependency` | `File` | `upload=File("file")` |
| `ServiceInject` | `Inject` | `service: MyService = Inject()` |

### 2. Import Changes

**Before (v0.2.x):**
```python
from zenith import ServiceDecorator, AuthDependency, FileDependency, ServiceInject

@ServiceDecorator()
class UserService:
    pass

@app.get("/protected")
async def protected(user=AuthDependency()):
    pass
```

**After (v0.3.0):**
```python
from zenith import Service, Auth, File, Inject

class UserService(Service):
    pass

@app.get("/protected")
async def protected(user=Auth):
    pass
```

## New Features in v0.3.0

### 1. Enhanced File Upload API
The File dependency now supports intuitive string-based sizes and predefined type constants:

```python
from zenith import File, UploadedFile, IMAGE_TYPES, DOCUMENT_TYPES, MB

@app.post("/upload")
async def upload_file(
    file: UploadedFile = File(
        max_size="10MB",  # String sizes instead of bytes
        allowed_types=IMAGE_TYPES,  # Predefined constants
        allowed_extensions=[".jpg", ".png"]
    )
):
    return {"filename": file.filename, "size": file.size}
```

Available constants:
- Type collections: `IMAGE_TYPES`, `DOCUMENT_TYPES`, `AUDIO_TYPES`, `VIDEO_TYPES`, `ARCHIVE_TYPES`
- Size units: `KB`, `MB`, `GB`

### 2. High-Level Decorators
New decorators for common patterns:
```python
from zenith import cache, rate_limit, auth_required, paginate, returns, validate, transaction

@app.get("/users")
@cache(ttl=300)  # Cache for 5 minutes
@rate_limit("10/minute")
@paginate(default_limit=20)
async def list_users():
    return await User.all()

@app.get("/users/{id}")
@returns(User)  # Auto-404 if None
async def get_user(id: int):
    return await User.find(id)
```

### 2. Enhanced Dependency Injection
Cleaner shortcuts for common dependencies:
```python
from zenith import DB, CurrentUser, Cache, Request

@app.get("/profile")
async def get_profile(user=CurrentUser):  # Instead of Depends(get_current_user)
    return user

@app.get("/data")
async def get_data(db=DB):  # Instead of Depends(get_session)
    return await db.query(Data).all()
```

### 3. Pagination Utilities
Built-in pagination support:
```python
from zenith import Paginate, PaginatedResponse

@app.get("/posts")
async def list_posts(pagination: Paginate = Paginate()):
    posts = await Post.paginate(pagination.page, pagination.limit)
    return PaginatedResponse.create(
        items=posts,
        page=pagination.page,
        limit=pagination.limit,
        total=await Post.count()
    )
```

## Migration Steps

### Step 1: Update Imports
Search and replace deprecated imports:
```bash
# Find all uses of deprecated imports
rg "ServiceDecorator|AuthDependency|FileDependency|ServiceInject"

# Update imports in your code:
# ServiceDecorator -> Service
# AuthDependency -> Auth
# FileDependency -> File
# ServiceInject -> Inject
```

### Step 2: Update Service Classes
Change from decorator pattern to inheritance:

**Before:**
```python
@ServiceDecorator()
class UserService:
    def __init__(self):
        pass
```

**After:**
```python
from zenith import Service

class UserService(Service):
    def __init__(self):
        super().__init__()
```

### Step 3: Update Dependency Injection

**Before:**
```python
from zenith import AuthDependency, ServiceInject

@app.get("/protected")
async def protected(user=AuthDependency(), service: UserService = ServiceInject()):
    pass
```

**After:**
```python
from zenith import Auth, Inject

@app.get("/protected")
async def protected(user=Auth, service: UserService = Inject()):
    pass
```

### Step 4: Take Advantage of New Features
Consider adopting the new high-level decorators for cleaner code:

```python
# Add caching to expensive operations
@cache(ttl=300)
async def expensive_operation():
    pass

# Add rate limiting to protect endpoints
@rate_limit("100/hour")
async def api_endpoint():
    pass

# Simplify authentication
@auth_required(role="admin")
async def admin_endpoint():
    pass
```

## Production Migration Examples

### Real-World Migration: API Service

Here's a complete example migrating a production API service:

**Before (v0.2.x):**
```python
# services/user_service.py
from zenith import ServiceDecorator, AuthDependency
from sqlalchemy.orm import Session

@ServiceDecorator()
class UserService:
    def __init__(self, db: Session):
        self.db = db

    def get_user_profile(self, user_id: int):
        return self.db.query(User).filter(User.id == user_id).first()

# routes/auth.py
from zenith import Zenith, AuthDependency, ServiceInject

app = Zenith()

@app.get("/profile")
async def get_profile(
    user=AuthDependency(),
    service: UserService = ServiceInject()
):
    return service.get_user_profile(user.id)
```

**After (v0.3.0):**
```python
# services/user_service.py
from zenith import Service, Session, CurrentUser

class UserService(Service):
    def __init__(self):
        super().__init__()

    async def get_user_profile(self, user_id: int, db=Session):
        async with db() as session:
            result = await session.execute(
                select(User).where(User.id == user_id)
            )
            return result.scalar_one_or_none()

# routes/auth.py
from zenith import Zenith, Auth, Inject

app = Zenith()

@app.get("/profile")
async def get_profile(
    user=Auth,
    service: UserService = Inject()
):
    return await service.get_user_profile(user.id)
```

### Real-World Migration: File Upload Service

**Before (v0.2.x):**
```python
from zenith import FileDependency
from starlette.datastructures import UploadFile

@app.post("/upload")
async def upload_file(
    file: UploadFile = FileDependency(
        max_size_bytes=10 * 1024 * 1024,  # 10MB in bytes
        allowed_mime_types=["image/jpeg", "image/png"]
    )
):
    content = await file.read()
    # Manual file saving logic...
    return {"filename": file.filename}
```

**After (v0.3.0):**
```python
from zenith import File, UploadedFile, IMAGE_TYPES, MB

@app.post("/upload")
async def upload_file(
    file: UploadedFile = File(
        max_size="10MB",  # Human-readable size
        allowed_types=IMAGE_TYPES  # Predefined constants
    )
):
    # File is automatically saved and validated
    # Move to final location with one line
    final_path = await file.move_to("/uploads/images/")

    return {
        "filename": file.filename,
        "original_name": file.original_filename,
        "size": file.size_bytes,
        "path": str(final_path)
    }
```

### Testing Migration Issues

Based on production testing, here are critical areas to test:

#### 1. Rate Limiting and Testing Mode

**Problem:** Rate limiting breaks test suites with 429 errors.

**Solution:** Use testing mode in your test setup:

```python
# conftest.py
import os
import pytest

@pytest.fixture(autouse=True)
def setup_testing_mode():
    """Enable testing mode for all tests."""
    os.environ["ZENITH_ENV"] = "test"
    yield
    if "ZENITH_ENV" in os.environ:
        del os.environ["ZENITH_ENV"]

# Alternative: Use testing parameter in app creation
from zenith import Zenith

app = Zenith(testing=True)  # Disables rate limiting
```

#### 2. Import Compatibility

Run this verification script after migration:

```python
# verify_migration.py
"""Verify v0.3.0 migration completed successfully."""

def check_imports():
    """Check for deprecated imports."""
    import ast
    import glob

    deprecated = ["ServiceDecorator", "AuthDependency", "FileDependency", "ServiceInject"]
    issues = []

    for file in glob.glob("**/*.py", recursive=True):
        if "venv" in file or "node_modules" in file:
            continue

        try:
            with open(file, 'r') as f:
                content = f.read()

            for dep in deprecated:
                if dep in content:
                    issues.append(f"{file}: Found deprecated {dep}")

        except Exception as e:
            print(f"Could not check {file}: {e}")

    if issues:
        print("❌ Migration issues found:")
        for issue in issues:
            print(f"  {issue}")
        return False
    else:
        print("✅ No deprecated imports found")
        return True

if __name__ == "__main__":
    check_imports()
```

#### 3. Database Model Updates

**Problem:** ZenithSQLModel references causing import errors.

**Migration:**
```python
# Before
from zenith.db import ZenithSQLModel

class User(ZenithSQLModel, table=True):
    id: int = Field(primary_key=True)

# After
from zenith import Model

class User(Model, table=True):
    id: int = Field(primary_key=True)
```

**Verification script:**
```python
# verify_models.py
import glob

def check_model_imports():
    """Check for ZenithSQLModel usage."""
    issues = []

    for file in glob.glob("**/*.py", recursive=True):
        if "venv" in file:
            continue

        with open(file, 'r') as f:
            content = f.read()

        if "ZenithSQLModel" in content:
            issues.append(f"{file}: Replace ZenithSQLModel with Model")

    return issues
```

## Step-by-Step Production Migration

### Phase 1: Preparation (5-10 minutes)

1. **Backup your codebase:**
   ```bash
   git checkout -b migration-v0.3.0
   git commit -am "Pre-migration checkpoint"
   ```

2. **Update Zenith version:**
   ```bash
   pip install zenith-web==0.3.0
   # or
   uv add zenith-web@0.3.0
   ```

3. **Create testing branch:**
   ```bash
   git checkout -b test-migration
   ```

### Phase 2: Automated Replacements (10-15 minutes)

Run these search-and-replace operations:

```bash
# Replace imports (use your preferred editor's find/replace)
find . -name "*.py" -not -path "./venv/*" -exec sed -i.bak 's/ServiceDecorator/Service/g' {} \;
find . -name "*.py" -not -path "./venv/*" -exec sed -i.bak 's/AuthDependency/Auth/g' {} \;
find . -name "*.py" -not -path "./venv/*" -exec sed -i.bak 's/FileDependency/File/g' {} \;
find . -name "*.py" -not -path "./venv/*" -exec sed -i.bak 's/ServiceInject/Inject/g' {} \;
find . -name "*.py" -not -path "./venv/*" -exec sed -i.bak 's/ZenithSQLModel/Model/g' {} \;

# Clean up backup files
find . -name "*.bak" -delete
```

### Phase 3: Manual Code Updates (15-30 minutes)

1. **Update service classes:**
   ```python
   # Change decorator pattern to inheritance
   # @ServiceDecorator() -> class MyService(Service):
   ```

2. **Update dependency injection:**
   ```python
   # Change function calls to direct assignment
   # user=AuthDependency() -> user=Auth
   ```

3. **Enable testing mode:**
   ```python
   # In test configuration
   app = Zenith(testing=True)
   # or set environment variable
   os.environ["ZENITH_ENV"] = "test"
   ```

### Phase 4: Testing and Validation (15-30 minutes)

1. **Run import verification:**
   ```bash
   python -m py_compile your_app.py  # Check syntax
   python verify_migration.py        # Check deprecated imports
   ```

2. **Run test suite:**
   ```bash
   # With testing mode enabled
   ZENITH_ENV=test pytest

   # Or if using zen CLI
   zen dev --testing  # For development server
   ```

3. **Test critical endpoints:**
   ```bash
   # Authentication endpoints
   curl -X POST http://localhost:8000/auth/login -d '{"email":"test@example.com","password":"test"}'

   # File upload endpoints
   curl -X POST -F "file=@test.jpg" http://localhost:8000/upload

   # Protected endpoints
   curl -H "Authorization: Bearer <token>" http://localhost:8000/protected
   ```

### Phase 5: Performance Validation (5-10 minutes)

Compare performance before/after:

```python
# benchmark_migration.py
import time
import asyncio
from your_app import app

async def benchmark_endpoint():
    """Quick performance check."""
    # Use TestClient or direct function calls
    start = time.time()

    # Test 100 requests to critical endpoint
    for _ in range(100):
        await your_critical_function()

    duration = time.time() - start
    print(f"100 requests took {duration:.2f}s ({100/duration:.1f} req/s)")

if __name__ == "__main__":
    asyncio.run(benchmark_endpoint())
```

## Common Migration Issues and Solutions

### Issue 1: Rate Limiting Breaking Tests

**Error:**
```
429 Too Many Requests: Rate limit exceeded
```

**Solution:**
```python
# In your test setup
import os
os.environ["ZENITH_ENV"] = "test"

# Or in app creation
app = Zenith(testing=True)
```

### Issue 2: Import Errors After Upgrade

**Error:**
```
ImportError: cannot import name 'ServiceDecorator' from 'zenith'
```

**Solution:**
Update all imports using the replacement table above, or use the automated script.

### Issue 3: Service Injection Not Working

**Error:**
```
TypeError: Service() missing 1 required positional argument
```

**Solution:**
Ensure service classes inherit from `Service` base class:
```python
from zenith import Service

class UserService(Service):
    def __init__(self):
        super().__init__()  # Required for proper DI
```

### Issue 4: File Upload Validation Errors

**Error:**
```
AttributeError: 'UploadFile' object has no attribute 'is_image'
```

**Solution:**
Use the new `UploadedFile` type instead of raw `UploadFile`:
```python
from zenith import File, UploadedFile

@app.post("/upload")
async def upload(file: UploadedFile = File()):  # Note: UploadedFile type
    if file.is_image():  # Now available
        # Process image
        pass
```

## Rollback Plan

If migration issues occur in production:

1. **Immediate rollback:**
   ```bash
   git checkout main
   pip install zenith-web==0.2.x  # Previous version
   ```

2. **Deploy previous version**

3. **Fix issues offline:**
   ```bash
   git checkout migration-v0.3.0
   # Fix specific issues
   # Re-test thoroughly
   ```

## Testing Your Migration

1. **Syntax check:**
   ```bash
   python -c "import your_app; print('✅ Import successful')"
   ```

2. **Run full test suite:**
   ```bash
   ZENITH_ENV=test python -m pytest -v
   ```

3. **Test authentication flows:**
   ```bash
   # Test login/logout
   # Test protected endpoints
   # Test file uploads
   ```

4. **Load testing (optional):**
   ```bash
   # Use your preferred load testing tool
   wrk -t12 -c400 -d30s http://localhost:8000/api/health
   ```

## Need Help?

- Check the [examples](examples/) directory for v0.3.0 patterns
- Review the [API documentation](docs/api/) for detailed information
- Open an issue on [GitHub](https://github.com/nijaru/zenith/issues) for migration problems

## Benefits of Upgrading

1. **Cleaner API** - No confusing duplicate exports
2. **Better DX** - More intuitive naming and patterns
3. **New Features** - High-level decorators, pagination, enhanced DI
4. **Performance** - Thread-safe caching and optimizations
5. **Future-proof** - Aligned with v1.0 API direction