---
title: "Enhanced file upload example for Zenith."
description: |
  Demonstrates modern file upload handling with improved UX,
  showing both the enhanced UploadedFile API and traditional patterns.
  This addresses common pain points found in production applications.
---

import { Code } from '@astrojs/starlight/components';
import { Badge } from '@astrojs/starlight/components';

<div class="example-header">
  <Badge text="Intermediate" variant="caution" />
  <Badge text="Database" variant="note" />
  
  
</div>

## Overview

Demonstrates modern file upload handling with improved UX,
showing both the enhanced UploadedFile API and traditional patterns.
This addresses common pain points found in production applications.



## Running This Example

```bash
# Clone the repository
git clone https://github.com/nijaru/zenith.git
cd zenith

# Set required environment variable
export SECRET_KEY="your-secret-key-at-least-32-characters-long"

# Run the example
uv run python examples/06-file-upload.py
```

## Source Code

<Code code={`"""
Enhanced file upload example for Zenith.

Demonstrates modern file upload handling with improved UX,
showing both the enhanced UploadedFile API and traditional patterns.
This addresses common pain points found in production applications.
"""

import os
import uuid
from pathlib import Path

from pydantic import BaseModel
from starlette.datastructures import UploadFile

from zenith import File, Zenith
from zenith.exceptions import HTTPException
from zenith.web.files import UploadedFile

# Create app
app = Zenith()

# Upload directory
UPLOAD_DIR = Path("uploads")
UPLOAD_DIR.mkdir(exist_ok=True)

# Allowed file types
ALLOWED_IMAGES = \{".jpg", ".jpeg", ".png", ".gif", ".webp"\}
ALLOWED_DOCUMENTS = \{".pdf", ".doc", ".docx", ".txt", ".md"\}


class FileInfo(BaseModel):
    """Enhanced file upload response."""

    filename: str
    original_filename: str
    size_bytes: int
    content_type: str
    saved_path: str
    file_type: str  # image, audio, video, document, other
    url: str | None = None


def get_file_type(file: UploadedFile | UploadFile) -> str:
    """Determine the general file type from content type or extension."""
    if hasattr(file, 'is_image') and file.is_image():
        return "image"
    elif hasattr(file, 'is_audio') and file.is_audio():
        return "audio"
    elif hasattr(file, 'is_video') and file.is_video():
        return "video"
    elif hasattr(file, 'is_pdf') and file.is_pdf():
        return "document"
    elif hasattr(file, 'content_type') and file.content_type:
        if file.content_type.startswith("image/"):
            return "image"
        elif file.content_type.startswith("audio/"):
            return "audio"
        elif file.content_type.startswith("video/"):
            return "video"
        elif "pdf" in file.content_type:
            return "document"
    return "other"


@app.post("/upload/modern", response_model=FileInfo)
async def upload_modern(file: UploadedFile = File(
    max_size=10 * 1024 * 1024,  # 10MB
    allowed_types=["image/jpeg", "image/png", "audio/mpeg", "audio/wav", "application/pdf"]
)) -> FileInfo:
    """
    Modern file upload using enhanced UploadedFile API.

    This demonstrates the improved UX with automatic validation
    and convenient file handling methods.
    """
    # Generate UUID-based filename to avoid conflicts
    file_id = str(uuid.uuid4())
    extension = file.get_extension()
    safe_filename = f"\{file_id\}\{extension\}"

    # Use convenient move_to method (much cleaner than manual file handling)
    final_path = await file.move_to(UPLOAD_DIR / safe_filename)

    return FileInfo(
        filename=safe_filename,
        original_filename=file.original_filename,
        size_bytes=file.size_bytes,
        content_type=file.content_type,
        saved_path=str(final_path),
        file_type=get_file_type(file),
        url=f"/files/\{safe_filename\}",
    )


@app.post("/upload/image")
async def upload_image(file: UploadFile = File()) -> FileInfo:
    """Upload a single image file (traditional approach for comparison)."""
    # Validate file type
    ext = Path(file.filename).suffix.lower()
    if ext not in ALLOWED_IMAGES:
        raise HTTPException(400, f"Invalid image type. Allowed: \{', '.join(ALLOWED_IMAGES)\}")

    # Validate file size (5MB max)
    contents = await file.read()
    if len(contents) > 5 * 1024 * 1024:
        raise HTTPException(413, "File too large. Maximum size: 5MB")

    # Save file
    save_path = UPLOAD_DIR / f"image_\{file.filename\}"
    with open(save_path, "wb") as f:
        f.write(contents)

    return FileInfo(
        filename=file.filename,
        original_filename=file.filename,
        size_bytes=len(contents),
        content_type=file.content_type,
        saved_path=str(save_path),
        file_type=get_file_type(file),
    )


@app.post("/upload/document")
async def upload_document(file: UploadFile = File()) -> FileInfo:
    """Upload a document file."""
    # Validate file type
    ext = Path(file.filename).suffix.lower()
    if ext not in ALLOWED_DOCUMENTS:
        raise ValueError(
            f"Invalid document type. Allowed: \{', '.join(ALLOWED_DOCUMENTS)\}"
        )

    # Read and save
    contents = await file.read()
    save_path = UPLOAD_DIR / f"doc_\{file.filename\}"
    with open(save_path, "wb") as f:
        f.write(contents)

    return FileInfo(
        filename=file.filename,
        size_bytes=len(contents),
        content_type=file.content_type,
        saved_path=str(save_path),
    )


@app.post("/upload/multiple")
async def upload_multiple(files: list[UploadFile] = File()) -> list[FileInfo]:
    """Upload multiple files at once."""
    results = []

    for file in files:
        # Save each file
        contents = await file.read()
        save_path = UPLOAD_DIR / f"multi_\{file.filename\}"
        with open(save_path, "wb") as f:
            f.write(contents)

        results.append(
            FileInfo(
                filename=file.filename,
                size_bytes=len(contents),
                content_type=file.content_type,
                saved_path=str(save_path),
            )
        )

    return results


@app.post("/upload/profile")
async def upload_profile(
    username: str, bio: str | None = None, avatar: UploadFile = File()
) -> dict:
    """Upload profile with avatar image (mixed form data)."""
    # Validate avatar
    ext = Path(avatar.filename).suffix.lower()
    if ext not in ALLOWED_IMAGES:
        raise ValueError("Avatar must be an image file")

    # Save avatar
    contents = await avatar.read()
    avatar_path = UPLOAD_DIR / f"avatar_\{username\}\{ext\}"
    with open(avatar_path, "wb") as f:
        f.write(contents)

    return \{
        "username": username,
        "bio": bio or "No bio provided",
        "avatar": str(avatar_path),
        "avatar_size_bytes": len(contents),
    \}


@app.get("/files")
async def list_files() -> list[dict]:
    """List all uploaded files."""
    files = []
    for filepath in UPLOAD_DIR.iterdir():
        if filepath.is_file():
            stat = filepath.stat()
            files.append(
                \{
                    "name": filepath.name,
                    "size_bytes": stat.st_size,
                    "modified": stat.st_mtime,
                \}
            )
    return files


@app.delete("/files/\{filename\}")
async def delete_file(filename: str) -> dict:
    """Delete an uploaded file."""
    filepath = UPLOAD_DIR / filename
    if not filepath.exists():
        raise ValueError(f"File \{filename\} not found")

    os.remove(filepath)
    return \{"message": f"File \{filename\} deleted"\}


@app.get("/health")
async def health() -> dict:
    return \{"status": "healthy", "upload_dir": str(UPLOAD_DIR)\}


if __name__ == "__main__":
    import uvicorn

    print("📁 Enhanced File Upload Example")
    print("Upload directory:", UPLOAD_DIR.absolute())
    print("\nEndpoints:")
    print("  POST /upload/modern - Modern enhanced upload (recommended)")
    print("  POST /upload/image - Upload single image (traditional)")
    print("  POST /upload/document - Upload document")
    print("  POST /upload/multiple - Upload multiple files")
    print("  POST /upload/profile - Mixed form with file")
    print("  GET /files - List uploaded files")
    print("  DELETE /files/\{filename\} - Delete file")
    print("\nTest with curl:")
    print('  # Modern enhanced API:')
    print('  curl -X POST -F "file=@song.mp3" http://localhost:8006/upload/modern')
    print('  curl -X POST -F "file=@document.pdf" http://localhost:8006/upload/modern')
    print()
    print('  # Traditional API:')
    print('  curl -X POST -F "file=@image.jpg" http://localhost:8006/upload/image')
    uvicorn.run("file_upload_example:app", host="127.0.0.1", port=8006, reload=True)
`} lang="python" title="examples/06-file-upload.py" />

## What This Example Demonstrates

**Database Integration**: ZenithModel usage with automatic session management

**Route Handlers**: HTTP endpoint definition and request handling

## Next Steps

- **Modify the code**: Try changing the routes or adding new features
- **Run tests**: Add test cases for your modifications
- **Explore more**: Check out other examples in the [examples directory](https://github.com/nijaru/zenith/tree/main/examples)
- **Read the docs**: Learn more about [Zenith concepts](/concepts/)

---

*This page is auto-generated from [`examples/06-file-upload.py`](https://github.com/nijaru/zenith/blob/main/examples/06-file-upload.py).
To suggest changes, edit the source file and the documentation will update automatically.*
